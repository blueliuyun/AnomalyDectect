# -*- coding: utf-8 -*-
"""
Created on Mon Nov 19 15:02:11 2018

Reference : https://stackoverflow.com/questions/22583391/peak-signal-detection-in-realtime-timeseries-data/43512887#43512887
# Implementation of algorithm from https://stackoverflow.com/a/22640362/6029703

@author: tianye
"""
import numpy as np
import pylab

def thresholding_algo(y, lag, threshold, influence):
    nFlag = 0x00
    signals = np.zeros(len(y))
    filteredY = np.array(y)
    avgFilter = [0]*len(y)
    stdFilter = [0]*len(y)
    avgFilter[lag - 1] = np.mean(y[0:lag])
    stdFilter[lag - 1] = np.std(y[0:lag])
    for i in range(lag, len(y)):
        if abs(y[i] - avgFilter[i-1]) > threshold * stdFilter [i-1]:
            if y[i] > avgFilter[i-1]:                
                signals[i] = 1
                if nFlag == 0x00:
                    nFlag = i
                    print('nFlag = %d' % (nFlag))
            else:
                signals[i] = -1
                if nFlag == 0x00:
                    nFlag = i
                    print('nFlag = %d' % (nFlag))

            filteredY[i] = influence * y[i] + (1 - influence) * filteredY[i-1]
            avgFilter[i] = np.mean(filteredY[(i-lag+1):i+1])
            stdFilter[i] = np.std(filteredY[(i-lag+1):i+1])
        else:
            signals[i] = 0
            filteredY[i] = y[i]
            avgFilter[i] = np.mean(filteredY[(i-lag+1):i+1])
            stdFilter[i] = np.std(filteredY[(i-lag+1):i+1])

    return dict(signals = np.asarray(signals),
                avgFilter = np.asarray(avgFilter),
                stdFilter = np.asarray(stdFilter))
    
# Data
"""
y = np.array([1,1,1.1,1,0.9,1,1,1.1,1,0.9,1,1.1,1,1,0.9,1,1,1.1,1,1,1,1,1.1,0.9,1,1.1,1,1,0.9,
       1,1.1,1,1,1.1,1,0.8,0.9,1,1.2,0.9,1,1,1.1,1.2,1,1.5,1,3,2,5,3,2,1,1,1,0.9,1,1,3,
       2.6,4,3,3.2,2,1,1,0.8,4,4,2,2.5,1,1,1])
"""
y = np.array([132, 136, 146, 148, 154, 159, 161, 163, 167, 169, 169, 167, 169, 169, 169, 163, 161, 156, 154, 146, 140, 134, 123, 117, 107, 94, 86, 75, 63, 50, 38, 21, 7, -3, -17, -28, -44, -57, -69, -80, -96, -105, -115, -127, -134, -144, -150, -161, -169, -173, -179, -184, -188, -192, -194, -198, -200, -202, -204, -204, -202, -200, -196, -196, -194, -190, -184, -181, -173, -167, -158, -150, -140, -129, -117, -102, -90, -80, -67, -57, -44, -26, -15, 0, 13, 26, 40, 52, 61, 71, 86, 94, 107, 115, 123, 129, 134, 142, 150, 152, 158, 161, 165, 165, 169, 173, 173, 169, 169, 169, 167, 165, 163, 161, 158, 150, 142, 132, 129, 117, 113, 102, 86, 73, 63, 52, 40, 25, 9, -5, -19, -32, -46, -55, -69, -84, -98, -107, -119, -129, -138, -148, -156, -165, -173, -179, -181, -188, -194, -196, -200, -204, -206, -208, -210, -208, -206, -204, -204, -200, -198, -194, -188, -181, -175, -171, -163, -156, -144, -131, -121, -105, -98, -86, -71, -55, -40, -28, -15, -1, 11, 21, 36, 52, 63, 71, 82, 94, 104, 115, 119, 129, 136, 144, 150, 154, 159, 161, 161, 169, 171, 173, 177, 177, 171, 169, 169, 165, 165, 159, 156, 150, 142, 138, 129, 119, 111, 100, 92, 79, 65, 55, 40, 26, 11, -1, -15, -28, -38, -53, -63, -80, -90, -105, -113, -123, -134, -146, -158, -169, -171, -175, -183, -184, -190, -194, -200, -204, -204, -204, -208, -206, -210, -202, -204, -198, -196, -192, -190, -184, -175, -169, -161, -154, -144, -134, -121, -109, -100, -82, -77, -65, -48, -32, -19, -3, 5, 21, 34, 48, 59, 71, 80, 92, 102, 115, 123, 131, 136, 142, 146, 154, 158, 163, 169, 169, 171, 173, 175, 175, 179, 183, 177, 169, 158, 154, 158, 161, 159, 144, 125, 111, 107, 107, 102, 86, 71, 53, 36, 28, 13, 1, -7, -23, -40, -53, -67, -75, -90, -102, -113, -125, -134, -144, -156, -161, -167, -175, -183, -190, -194, -196, -200, -204, -206, -208, -206, -208, -204, -206, -202, -202, -204, -198, -192, -184, -179, -171, -165, -158, -148, -136, -125, -115, -102, -88, -75, -59, -46, -32, -21, -5, 7, 21, 36, 52, 61, 71, 82, 92, 102, 111, 121, 131, 136, 142, 150, 154, 159, 163, 165, 167, 171, 173, 173, 173, 179, 177, 173, 167, 163, 159, 158, 150, 142, 138, 131, 123, 115, 104, 92, 79, 65, 53, 42, 28, 11, -3, -15, -25, -36, -52, -67, -80, -96, -104, -111, -125, -134, -142, -156, -165, -169, -177, -181, -183, -190, -196, -198, -200, -202, -206, -208, -210, -208, -208, -202, -200, -200, -192, -190, -184, -179, -171, -163, -158, -148, -138, -125, -113, -100, -88, -77, -61, -50, -38, -19, -7, 7, 19, 36, 48, 57, 71, 80, 88, 104, 115, 123, 129, 136, 140, 150, 158, 159, 163, 163, 169, 167, 173, 175, 177, 177, 175, 171, 167, 163, 161, 152, 154, 146, 138, 131, 123, 113, 104, 90, 79, 65, 53, 42, 26, 13, -3, -11, -26, -42, -52, -69, -82, -92, -105, -117, -125, -136, -144, -152, -163, -171, -177, -183, -188, -192, -198, -200, -204, -204, -208, -208, -210, -208, -206, -204, -204, -200, -200, -188, -183, -175, -171, -167, -161, -148, -136, -127, -113, -98, -90, -79, -65, -46, -30, -21, -9, 7, 15, 30, 44, 55, 65, 79, 88, 96, 107, 113, 125, 129, 138, 142, 150, 154, 158, 163, 163, 169, 167, 171, 173, 173, 173, 169, 169, 167, 165, 161, 158, 150, 144, 136, 129, 119, 109, 102, 90, 79, 67, 55, 44, 28, 11, -1, -15, -25, -40, -52, -63, -79, -90, -102, -113, -123, -132, -144, -154, -165, -173, -173, -181, -186, -188, -196, -198, -204, -204, -204, -206, -204, -206, -204, -206, -202, -198, -196, -188, -184, -175, -171, -163, -152, -144, -132, -125, -109, -96, -86, -73, -59, -46, -32, -15, -1, 11, 25, 38, 50, 63, 75, 88, 96, 109, 119, 129, 136, 140, 146, 154, 159, 165, 165, 169, 167, 173, 175, 175, 175, 171, 173, 167, 163, 159, 158, 152, 148, 138, 131, 123, 111, 104, 92, 80, 67, 53, 40, 26, 11, -1, -13, -28, -44, -53, -71, -84, -94, -104, -115, -129, -138, -146, -156, -163, -171, -179, -184, -184, -192, -198, -198, -200, -202, -206, -208, -206, -210, -204, -202, -200, -202, -200, -192, -186, -179, -173, -163, -161, -150, -138, -129, -115, -104, -92, -79, -65, -52, -34, -21, -11, 1, 15, 26, 42, 52, 65, 77, 86, 96, 105, 115, 123, 129, 134, 140, 148, 152, 161, 165, 167, 165, 165, 171, 179, 177, 169, 167, 167, 169, 169, 165, 159, 150, 142, 136, 131, 121, 109, 100, 86, 77, 63, 55, 40, 26, 7, -5, -15, -26, -40, -55, -71, -84, -96, -105, -113, -127, -134, -146, -158, -167, -169, -175, -184, -186, -190, -194, -200, -204, -204, -204, -206, -206, -204, -206, -202, -200, -198, -190, -186, -181, -171, -165, -158, -148, -140, -129, -113, -105, -92, -79, -65, -55, -42, -28, -11, 1, 17, 30, 44, 57, 67, 77, 88, 100, 109, 121, 127, 134, 142, 148, 152, 158, 161, 163, 169, 173, 175, 175, 177, 178, 175, -343, -3110, -11055, -21347, -28373, -31034, -27610, -16994, -5757, -1541, -5380, -15803, -28225, -32767, -25477, -13616, -4146, 343, -3248, -13519, -21804, -22415, -16626, -7120, 1697, 4033, 111, -5162, -9430, -10737, -5983, 2418, 8110, 9579, 8496, 5081, 1489, 1636, 5366, 10087, 14699, 17308, 15942, 12953, 11589, 11546, 12747, 16370, 20310, 21405, 20351, 18838, 16936, 15892, 17156, 19289, 20753, 21738, 21397, 19000, 16732, 16237, 16287, 16512, 17551, 17984, 16533, 14475, 12731, 11043, 10201, 10504, 10430, 9517, 8502, 6852, 4337, 2574, 2004, 1348, 547, 9, -1185, -3204, -4942, -6293, -7577, -8201, -8411, -9301, -10575, -11562, -12812, -14261, -14897, -14999, -15421, -15847, -16142, -16886, -17716, -18006, -18152, -18243, -17830, -17427, -17562, -17599, -17291, -17152, -16880, -16027, -15161, -14556, -13791, -13040, -12521, -11723, -10592, -9594, -8505, -7147, -6043, -5199, -4058, -2811, -1736, -448, 1007, 2198, 3299, 4528, 5599, 6603, 7864, 9076, 10051, 11130, 12219, 12982, 13714, 14618, 15362, 15982, 16718, 17318, 17674, 18063, 18401, 18510, 18667, 18882, 18859, 18709, 18624, 18366, 17903, 17524, 17119, 16518, 15911, 15310, 14495, 13616, 12795, 11847, 10804, 9860, 8860, 7692, 6555, 5453, 4214, 2965, 1824, 612, -643, -1807, -2996, -4256, -5420, -6521, -7679, -8766, -9725, -10719, -11731, -12600, -13425, -14259, -14967, -15572, -16183, -16714, -17136, -17551, -17892, -18050, -18144, -18237, -18202, -18069, -17934, -17703, -17327, -16926, -16472, -15895, -15265, -14620, -13861, -13026, -12196, -11305, -10309, -9303, -8293, -7187, -6058, -4952, -3790, -2584, -1416, -231, 994, 2185, 3345, 4532, 5700, 6798, 7906, 9008, 10014, 10982, 11949, 12841, 13650, 14444, 15186, 15828, 16410, 16953, 17391, 17755, 18081, 18310, 18437, 18514, 18524, 18420, 18254, 18034, 17709, 17306, 16857, 16323, 15703, 15040, 14317, 13504, 12647, 11758, 10795, 9785, 8756, 7681, 6555, 5422, 4270, 3079, 1876, 684, -529, -1745, -2927, -4098, -5274, -6409, -7513, -8604, -9648, -10637, -11596, -12508, -13348, -14140, -14886, -15556, -16156, -16691, -17150, -17526, -17844, -18081, -18227, -18304, -18316, -18229, -18061, -17828, -17514, -17117, -16659, -16125, -15508, -14832, -14099, -13298, -12440, -11533, -10573, -9559, -8515, -7434, -6312, -5164, -4000, -2807, -1605, -402, 801, 1998, 3171, 4345, 5518, 6669, 7787, 8866, 9899, 10887, 11833, 12739, 13583, 14365, 15092, 15741, 16323, 16847, 17294, 17663, 17954, 18173, 18304, 18360, 18341, 18239, 18056, 17799, 17460, 17044, 16560, 16007, 15379, 14681, 13926, 13113, 12240, 11319, 10350, 9336, 8280, 7191, 6062, 4913, 3748, 2561, 1360, 156, -1046, -2248, -3441, -4609, -5759, -6879, -7968, -9031, -10059, -11036, -11968, -12849, -13670, -14433, -15138, -15778, -16346, -16813, -17206, -17634, -17977, -18135, -18225, -18287, -18225, -18083, -17950, -17707, -17329, -16923, -16450, -15855, -15227, -14579, -13812, -12982, -12151, -11238, -10236, -9241, -8224, -7114, -5994, -4888, -3721, -2520, -1358, -169, 1054, 2229, 3383, 4567, 5713, 6806, 7910, 8987, 9981, 10945, 11893, 12762, 13564, 14348, 15059, 15678, 16260, 16780, 17192, 17543, 17848, 18046, 18158, 18223, 18210, 18081, 17909, 17666, 17320, 16903, 16441, 15880, 15252, 14581, 13837, 13017, 12157, 11255, 10282, 9268, 8241, 7158, 6033, 4908, 3749, 2551, 1368, 181, -1023, -2216, -3381, -4555, -5713, -6825, -7918, -8985, -9999, -10968, -11907, -12783, -13604, -14379, -15092, -15720, -16291, -16795, -17223, -17574, -17865, -18069, -18187, -18237, -18210, -18092, -17905, -17649, -17302, -16882, -16400, -15840, -15206, -14518, -13770, -12949, -12078, -11161, -10182, -9166, -8120, -7031, -5908, -4769, -3611, -2426, -1235, -36, 1160, 2341, 3501, 4661, 5815, 6943, 8035, 9087, 10093, 11051, 11976, 12853, 13666, 14423, 15117, 15734, 16294, 16782, 17198, 17537, 17803, 17992, 18094, 18125, 18079, 17954, 17749, 17474, 17117, 16686, 16183, 15612, 14974, 14271, 13508, 12685, 11814, 10895, 9924, 8910, 7856, 6771, 5651, 4516, 3358, 2179, 992, -192, -1383, -2566, -3732, -4886, -6014, -7120, -8191, -9236, -10238, -11195, -12103, -12963, -13760, -14504, -15188, -15807, -16348, -16782, -17177, -17603, -17909, -18034, -18129, -18171, -18069, -17938, -17794, -17518, -17125, -16724, -16231, -15628, -15005, -14340, -13556, -12726, -11895, -10964, -9966, -8985, -7954, -6837, -5736, -4628, -3455, -2271, -1123, 67, 1279, 2437, 3591, 4771, 5890, 6970, 8068, 9118, 10091, 11053, 11982, 12820, 13612, 14379, 15059, 15660, 16231, 16716, 17100, 17441, 17724, 17892, 17988, 18038, 17986, 17846, 17661, 17387, 17021, 16599, 16113, 15533, 14897, 14217, 13452, 12620, 11766, 10851, 9866, 8860, 7825, 6731, 5615, 4489, 3329, 2144, 973, -204, -1400, -2570, -3728, -4894, -6025, -7118, -8195, -9241, -10226, -11184, -12097, -12947, -13737, -14483, -15165, -15768, -16319, -16801, -17196, -17522, -17784, -17957, -18054, -18088, -18034, -17894, -17686, -17404, -17040, -16605, -16111, -15531, -14884, -14186, -13423, -12598, -11722, -10800, -9822, -8808, -7763, -6675, -5557, -4426, -3268, -2092, -917, 262, 1439, 2593, 3744, 4894, 6033, 7137, 8205, 9236, 10220, 11159, 12065, 12914, 13706, 14441, 15111, 15709, 16248, 16718, 17113, 17431, 17678, 17849, 17936, 17955, 17896, 17757, 17541, 17250, 16884, 16443, 15940, 15364, 14720, 14013, 13248, 12427, 11554, 10633, 9665, 8654, 7609, 6526, 5416, 4281, 3135, 1967, 788, -385, -1562, -2734, -3884, -5025, -6147, -7243, -8309, -9338, -10321, -11253, -12145, -12988, -13778, -14520, -15188, -15789, -16302, -16713, -17109, -17528, -17799, -17909, -18004, -18019, -17900, -17769, -17614, -17312, -16919, -16506, -15988, -15369, -14755, -14073, -13275, -12458, -11616, -10664, -9669, -8692, -7642, -6528, -5445, -4328, -3146, -1982, -832, 369, 1557, 2697, 3859, 5021, 6118, 7197, 8284, 9305, 10265, 11217, 12120, 12930, 13720, 14464, 15107, 15697, 16246, 16695, 17061, 17387, 17634, 17772, 17861, 17882, 17797, 17643, 17433, 17129, 16740, 16304, 15797, 15194, 14548, 13845, 13061, 12223, 11355, 10419, 9432, 8424, 7376, 6276, 5166, 4037, 2873, 1701, 537, -643, -1826, -2981, -4135, -5283, -6397, -7471, -8528, -9542, -10508, -11444, -12330, -13146, -13916, -14635, -15279, -15855, -16381, -16828, -17190, -17495, -17718, -17857, -17928, -17930, -17842, -17680, -17449, -17138, -16751, -16302, -15780, -15179, -14523, -13810, -13032, -12190, -11315, -10380, -9399, -8392, -7341, -6257, -5143, -4015, -2859, -1697, -533, 633, 1792, 2932, 4066, 5202, 6322, 7399, 8448, 9457, 10413, 11338, 12217, 13040, 13809, 14520, 15165, 15741, 16254, 16697, 17069, 17370, 17597, 17747, 17813, 17811, 17730, 17574, 17348, 17044, 16657, 16208, 15691, 15105, 14448, 13737, 12964, 12136, 11255, 10332, 9363, 8347, 7301, 6222, 5112, 3986, 2842, 1676, 508, -659, -1832, -2992, -4139, -5268, -6372, -7449, -8496, -9511, -10482, -11406, -12278, -13105, -13870, -14579, -15229, -15809, -16306, -16699, -17109, -17493, -17705, -17805, -17892, -17867, -17734, -17609, -17418, -17079, -16684, -16254, -15697, -15080, -14460, -13741, -12930, -12119, -11248, -10271, -9295, -8307, -7232, -6129, -5046, -3909, -2728, -1582, -423, 774, 1940, 3075, 4245, 5382, 6455, 7534, 8604, 9584, 10538, 11479, 12338, 13134, 13907, 14610, 15221, 15801, 16316, 16722, 17071, 17373, 17572, 17686, 17755, 17738, 17616, 17445, 17200, 16861, 16454, 16000, 15448, 14832, 14175, 13444, 12633, 11795, 10906, 9947, 8962, 7947, 6887, 5790, 4682, 3549, 2383, 1231, 69, -1111, -2270, -3410, -4557, -5684, -6769, -7829, -8866, -9848, -10793, -11704, -12560, -13348, -14092, -14780, -15391, -15942, -16439, -16847, -17183, -17460, -17651, -17761, -17809, -17782, -17670, -17483, -17233, -16894, -16485, -16019, -15477, -14863, -14196, -13465, -12673, -11833, -10949, -10005, -9022, -8006, -6956, -5867, -4765, -3640, -2489, -1333, -179, 976, 2121, 3247, 4376, 5503, 6603, 7669, 8698, 9683, 10623, 11525, 12386, 13186, 13938, 14626, 15240, 15797, 16292, 16711, 17063, 17337, 17547, 17668, 17715, 17693, 17593, 17416, 17171, 16847, 16445, 15976, 15445, 14841, 14175, 13450, 12670, 11829, 10945, 10012, 9033, 8016, 6971, 5887, 4780, 3655, 2508, 1348, 186, -976, -2140, -3289, -4424, -5540, -6634, -7696, -8731, -9727, -10679, -11583, -12440, -13242, -13992, -14683, -15314, -15868, -16323, -16703, -17125, -17466, -17628, -17724, -17784, -17716, -17582, -17456, -17217, -16851, -16458, -16000, -15410, -14797, -14155, -13406, -12593, -11781, -10876, -9895, -8925, -7921, -6829, -5740, -4651, -3497, -2331, -1200, -25, 1165, 2306, 3443, 4609, 5713, 6781, 7862, 8897, 9856, 10802, 11720, 12546, 13329, 14082, 14749, 15337, 15897, 16371, 16751, 17090, 17360, 17520, 17614, 17661, 17605, 17462, 17279, 17002, 16637, 16225, 15747, 15173, 14547, 13872, 13117, 12302, 11459, 10558, 9596, 8617, 7604, 6528, 5436, 4333, 3196, 2048, 903, -252, -1422, -2564, -3694])
        
# Settings: lag = 30, threshold = 5, influence = 0
lag = 30
threshold = 5
influence = 0

# Run algo with settings from above
result = thresholding_algo(y, lag=lag, threshold=threshold, influence=influence)

# Plot result
pylab.subplot(211)
pylab.plot(np.arange(1, len(y)+1), y)

pylab.plot(np.arange(1, len(y)+1),
           result["avgFilter"], color="cyan", lw=2)

pylab.plot(np.arange(1, len(y)+1),
           result["avgFilter"] + threshold * result["stdFilter"], color="green", lw=2)

pylab.plot(np.arange(1, len(y)+1),
           result["avgFilter"] - threshold * result["stdFilter"], color="green", lw=2)

pylab.subplot(212)
pylab.step(np.arange(1, len(y)+1), result["signals"], color="red", lw=2)
pylab.ylim(-1.5, 1.5)
